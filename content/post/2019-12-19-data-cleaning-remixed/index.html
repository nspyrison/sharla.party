---
title: data cleaning remixed
date: '2019-12-19'
editor_options: 
  chunk_output_type: console
---



<p>Instead of downloading a file from the website, I‚Äôll use my <a href=""><code>opendatatoronto</code> package</a> to read the data directly into R üíÖ</p>
<pre class="r"><code>library(opendatatoronto)

ttc_ridership_raw &lt;- search_packages(&quot;TTC Ridership Analysis&quot;) %&gt;%
  list_package_resources() %&gt;%
  get_resource()

ttc_ridership_raw</code></pre>
<pre><code>## # A tibble: 64 x 36
##    `TORONTO TRANSI‚Ä¶ ...2  ...3  ...4  ...5  ...6  ...7  ...8  ...9  ...10
##    &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 ANALYSIS OF RID‚Ä¶ &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  2 1985 TO 2018 AC‚Ä¶ &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  3 &lt;NA&gt;             &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  4 &lt;NA&gt;             FARE‚Ä¶ 2018  2017  2016  2015‚Ä¶ 2014  2013  2012  2011 
##  5 WHO              ADULT &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  6 &lt;NA&gt;             TOKE‚Ä¶ 46974 76106 1020‚Ä¶ 1109‚Ä¶ 1111‚Ä¶ 1123‚Ä¶ 1179‚Ä¶ 1247‚Ä¶
##  7 &lt;NA&gt;             TICK‚Ä¶ N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  8 &lt;NA&gt;             TWO-‚Ä¶ N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  9 &lt;NA&gt;             PRES‚Ä¶ 1168‚Ä¶ 67829 27397 13323 9862  8194  4399  1139 
## 10 &lt;NA&gt;             PRES‚Ä¶ 1752  N/A   N/A   N/A   N/A   N/A   N/A   N/A  
## # ‚Ä¶ with 54 more rows, and 26 more variables: ...11 &lt;chr&gt;, ...12 &lt;chr&gt;,
## #   ...13 &lt;chr&gt;, ...14 &lt;chr&gt;, ...15 &lt;chr&gt;, ...16 &lt;chr&gt;, ...17 &lt;chr&gt;,
## #   ...18 &lt;chr&gt;, ...19 &lt;chr&gt;, ...20 &lt;chr&gt;, ...21 &lt;chr&gt;, ...22 &lt;chr&gt;,
## #   ...23 &lt;chr&gt;, ...24 &lt;chr&gt;, ...25 &lt;chr&gt;, ...26 &lt;chr&gt;, ...27 &lt;chr&gt;,
## #   ...28 &lt;chr&gt;, ...29 &lt;chr&gt;, ...30 &lt;chr&gt;, ...31 &lt;chr&gt;, ...32 &lt;chr&gt;,
## #   ...33 &lt;chr&gt;, ...34 &lt;chr&gt;, ...35 &lt;chr&gt;, ...36 &lt;chr&gt;</code></pre>
<p>First, I want to remove all the preamble and change the column names to whatever is in the fourth row, since this contains information on the type of fare paid, as well as the years that the data covers.</p>
<p>I hyped the <a href=""><code>janitor</code> package</a> in my previous post, but now it has even more functionality! The <code>rows_to_names()</code> function does exactly what I want:</p>
<pre class="r"><code>library(janitor)

ttc_ridership &lt;- ttc_ridership_raw %&gt;% 
  row_to_names(row_number = 4)

ttc_ridership</code></pre>
<pre><code>## # A tibble: 60 x 36
##    NA    `FARE MEDIA` `2018` `2017` `2016` `2015 *` `2014` `2013` `2012`
##    &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
##  1 WHO   ADULT        &lt;NA&gt;   &lt;NA&gt;   &lt;NA&gt;   &lt;NA&gt;     &lt;NA&gt;   &lt;NA&gt;   &lt;NA&gt;  
##  2 &lt;NA&gt;  TOKENS       46974  76106  102073 110945   111157 112360 117962
##  3 &lt;NA&gt;  TICKETS      N/A    N/A    N/A    N/A      N/A    N/A    N/A   
##  4 &lt;NA&gt;  TWO-FARE     N/A    N/A    N/A    N/A      N/A    N/A    N/A   
##  5 &lt;NA&gt;  PRESTO - SI‚Ä¶ 116888 67829  27397  13323    9862   8194   4399  
##  6 &lt;NA&gt;  PRESTO - AD‚Ä¶ 1752   N/A    N/A    N/A      N/A    N/A    N/A   
##  7 &lt;NA&gt;  PRESTO - PO‚Ä¶ 74     N/A    N/A    N/A      N/A    N/A    N/A   
##  8 &lt;NA&gt;  PRESTO - SR‚Ä¶ 1049   1271   1157   N/A      N/A    N/A    N/A   
##  9 &lt;NA&gt;  PRESTO - SR‚Ä¶ 856    821    582    N/A      N/A    N/A    N/A   
## 10 &lt;NA&gt;  PRESTO - MO‚Ä¶ 19111  1613   N/A    N/A      N/A    N/A    N/A   
## # ‚Ä¶ with 50 more rows, and 27 more variables: `2011` &lt;chr&gt;, `2010` &lt;chr&gt;,
## #   `2009` &lt;chr&gt;, `2008` &lt;chr&gt;, `2007` &lt;chr&gt;, `2006` &lt;chr&gt;, `2005` &lt;chr&gt;,
## #   `2004` &lt;chr&gt;, `2003` &lt;chr&gt;, `2002` &lt;chr&gt;, `2001` &lt;chr&gt;, `2000` &lt;chr&gt;,
## #   `1999` &lt;chr&gt;, `1998` &lt;chr&gt;, `1997` &lt;chr&gt;, `1996` &lt;chr&gt;, `1995` &lt;chr&gt;,
## #   `1994` &lt;chr&gt;, `1993` &lt;chr&gt;, `1992` &lt;chr&gt;, `1991` &lt;chr&gt;, `1990` &lt;chr&gt;,
## #   `1989` &lt;chr&gt;, `1988` &lt;chr&gt;, `1987` &lt;chr&gt;, `1986` &lt;chr&gt;, `1985` &lt;chr&gt;</code></pre>
<p>This also removes the fourth row itself and all the rows prior, which gets rid of the preamble! If you want to use this function but don‚Äôt like that behaviour, it‚Äôs controlled in the <code>remove_row</code> and <code>remove_rows_above</code> arguments (both of which default to <code>TRUE</code>).</p>
<p>Next up, I‚Äôm going to use <code>janitor</code>‚Äôs famous <code>clean_names()</code> function, because dealing with column names like ‚ÄúFARE MEDIA‚Äù and &quot;2015 *&quot; are annoying, but also because the column name <code>NA</code> is super illegal in R (source?)</p>
<pre class="r"><code>ttc_ridership &lt;- ttc_ridership %&gt;%
  clean_names()

ttc_ridership</code></pre>
<pre><code>## # A tibble: 60 x 36
##    na    fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012 x2011 x2010
##    &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 WHO   ADULT      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  2 &lt;NA&gt;  TOKENS     46974 76106 1020‚Ä¶ 1109‚Ä¶ 1111‚Ä¶ 1123‚Ä¶ 1179‚Ä¶ 1247‚Ä¶ 1203‚Ä¶
##  3 &lt;NA&gt;  TICKETS    N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A   1298 
##  4 &lt;NA&gt;  TWO-FARE   N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  5 &lt;NA&gt;  PRESTO - ‚Ä¶ 1168‚Ä¶ 67829 27397 13323 9862  8194  4399  1139  0    
##  6 &lt;NA&gt;  PRESTO - ‚Ä¶ 1752  N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  7 &lt;NA&gt;  PRESTO - ‚Ä¶ 74    N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  8 &lt;NA&gt;  PRESTO - ‚Ä¶ 1049  1271  1157  N/A   N/A   N/A   N/A   N/A   N/A  
##  9 &lt;NA&gt;  PRESTO - ‚Ä¶ 856   821   582   N/A   N/A   N/A   N/A   N/A   N/A  
## 10 &lt;NA&gt;  PRESTO - ‚Ä¶ 19111 1613  N/A   N/A   N/A   N/A   N/A   N/A   N/A  
## # ‚Ä¶ with 50 more rows, and 25 more variables: x2009 &lt;chr&gt;, x2008 &lt;chr&gt;,
## #   x2007 &lt;chr&gt;, x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;, x2003 &lt;chr&gt;,
## #   x2002 &lt;chr&gt;, x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;, x1998 &lt;chr&gt;,
## #   x1997 &lt;chr&gt;, x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;, x1993 &lt;chr&gt;,
## #   x1992 &lt;chr&gt;, x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;, x1988 &lt;chr&gt;,
## #   x1987 &lt;chr&gt;, x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<p>To clean up a little more, I‚Äôm going to get rid of any rows where <code>fare_media</code> is a total or subtotal (they‚Äôre nice for looking at the table itself, but not helpful from a tidy data standpoint) or where it‚Äôs missing (these represent those annoying ‚Äúpost-amble‚Äù rows&quot;):</p>
<pre class="r"><code>library(dplyr)

ttc_ridership &lt;- ttc_ridership %&gt;%
  filter(!fare_media %in% c(&quot;SYSTEM TOTAL&quot;, &quot;SUB-TOTAL&quot;),
         !is.na(fare_media))

ttc_ridership</code></pre>
<pre><code>## # A tibble: 47 x 36
##    na    fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012 x2011 x2010
##    &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 WHO   ADULT      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  2 &lt;NA&gt;  TOKENS     46974 76106 1020‚Ä¶ 1109‚Ä¶ 1111‚Ä¶ 1123‚Ä¶ 1179‚Ä¶ 1247‚Ä¶ 1203‚Ä¶
##  3 &lt;NA&gt;  TICKETS    N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A   1298 
##  4 &lt;NA&gt;  TWO-FARE   N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  5 &lt;NA&gt;  PRESTO - ‚Ä¶ 1168‚Ä¶ 67829 27397 13323 9862  8194  4399  1139  0    
##  6 &lt;NA&gt;  PRESTO - ‚Ä¶ 1752  N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  7 &lt;NA&gt;  PRESTO - ‚Ä¶ 74    N/A   N/A   N/A   N/A   N/A   N/A   N/A   N/A  
##  8 &lt;NA&gt;  PRESTO - ‚Ä¶ 1049  1271  1157  N/A   N/A   N/A   N/A   N/A   N/A  
##  9 &lt;NA&gt;  PRESTO - ‚Ä¶ 856   821   582   N/A   N/A   N/A   N/A   N/A   N/A  
## 10 &lt;NA&gt;  PRESTO - ‚Ä¶ 19111 1613  N/A   N/A   N/A   N/A   N/A   N/A   N/A  
## # ‚Ä¶ with 37 more rows, and 25 more variables: x2009 &lt;chr&gt;, x2008 &lt;chr&gt;,
## #   x2007 &lt;chr&gt;, x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;, x2003 &lt;chr&gt;,
## #   x2002 &lt;chr&gt;, x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;, x1998 &lt;chr&gt;,
## #   x1997 &lt;chr&gt;, x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;, x1993 &lt;chr&gt;,
## #   x1992 &lt;chr&gt;, x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;, x1988 &lt;chr&gt;,
## #   x1987 &lt;chr&gt;, x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<p>I‚Äôll also replace all ‚ÄúN/A‚Äù values with literal <code>NA</code>s, for all columns. <code>dplyr</code>‚Äôs <code>mutate_all()</code> is just like its <code>mutate()</code>, except it applies the function to <em>all</em> columns.</p>
<pre class="r"><code>ttc_ridership &lt;- ttc_ridership %&gt;%
  mutate_all(~ ifelse(.x == &quot;N/A&quot;, NA, .x))

ttc_ridership</code></pre>
<pre><code>## # A tibble: 47 x 36
##    na    fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012 x2011 x2010
##    &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 WHO   ADULT      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  2 &lt;NA&gt;  TOKENS     46974 76106 1020‚Ä¶ 1109‚Ä¶ 1111‚Ä¶ 1123‚Ä¶ 1179‚Ä¶ 1247‚Ä¶ 1203‚Ä¶
##  3 &lt;NA&gt;  TICKETS    &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  1298 
##  4 &lt;NA&gt;  TWO-FARE   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  5 &lt;NA&gt;  PRESTO - ‚Ä¶ 1168‚Ä¶ 67829 27397 13323 9862  8194  4399  1139  0    
##  6 &lt;NA&gt;  PRESTO - ‚Ä¶ 1752  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  7 &lt;NA&gt;  PRESTO - ‚Ä¶ 74    &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  8 &lt;NA&gt;  PRESTO - ‚Ä¶ 1049  1271  1157  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  9 &lt;NA&gt;  PRESTO - ‚Ä¶ 856   821   582   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 10 &lt;NA&gt;  PRESTO - ‚Ä¶ 19111 1613  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## # ‚Ä¶ with 37 more rows, and 25 more variables: x2009 &lt;chr&gt;, x2008 &lt;chr&gt;,
## #   x2007 &lt;chr&gt;, x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;, x2003 &lt;chr&gt;,
## #   x2002 &lt;chr&gt;, x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;, x1998 &lt;chr&gt;,
## #   x1997 &lt;chr&gt;, x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;, x1993 &lt;chr&gt;,
## #   x1992 &lt;chr&gt;, x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;, x1988 &lt;chr&gt;,
## #   x1987 &lt;chr&gt;, x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<p>I think that‚Äôs a good start!</p>
<p>In my previous iteration of this post, I did a really, really brute force method of separating out the different sections (WHO/WHERE/WHEN) and subsections (ADULT/SENIOR/CHILD etc) by looking at the row number where each section started/ended and creating different data sets based on that.</p>
<p>I don‚Äôt want to do that! Talk more here.</p>
<pre class="r"><code>library(tidyr)

ttc_ridership &lt;- ttc_ridership %&gt;%
  fill(na, .direction = &quot;down&quot;) %&gt;%
  rename(section = na)</code></pre>
<p>Since that post, <a href="https://luisdva.github.io/">Luis D. Verde Arregoitia</a> has created the <a href="https://github.com/luisDVA/unheadr/"><code>unheadr</code> package</a>. One of <code>unheadr</code>‚Äôs goals is to help wrangle data when it has embedded subheaders, exactly the case we have here!</p>
<p>The package‚Äôs star function <code>untangle2()</code> takes embedded subheaders and puts them into their own column, so that you don‚Äôt have a header (which probably contains important, though separate, information) mixed in with another variable.</p>
<p>In this data set, everything from the row where <code>na</code> is ‚ÄúWHO‚Äù to the row before where it‚Äôs ‚ÄúWHERE‚Äù is data on <em>who</em> paid for transit (adults, seniors/students, or children, each of which is its own subsection that we‚Äôll get to), everything from ‚ÄúWHERE‚Äù to one before ‚ÄúWHEN‚Äù is data on <em>where</em> people paid for transit (bus or rail, again with further breakdowns), and everything from ‚ÄúWHEN‚Äù to the end is <em>when</em> people paid for transit (weekdays or weekends/holidays).</p>
<p>If we want to keep track of which rows contain who/where/when data, we need it in a</p>
<p><code>untangle2()</code> assumes that everything else in the subheader row doesn‚Äôt contain useful information and we can get rid of it. This works well when looking at the WHO data:</p>
<pre class="r"><code>ttc_ridership %&gt;%
  filter(section == &quot;WHO&quot;) %&gt;%
  filter(fare_media %in% c(&quot;ADULT&quot;, &quot;SENIOR/STUDENT&quot;, &quot;CHILDREN&quot;))</code></pre>
<pre><code>## # A tibble: 3 x 36
##   section fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012 x2011 x2010
##   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 WHO     ADULT      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 2 WHO     SENIOR/ST‚Ä¶ &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 3 WHO     CHILDREN   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## # ‚Ä¶ with 25 more variables: x2009 &lt;chr&gt;, x2008 &lt;chr&gt;, x2007 &lt;chr&gt;,
## #   x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;, x2003 &lt;chr&gt;, x2002 &lt;chr&gt;,
## #   x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;, x1998 &lt;chr&gt;, x1997 &lt;chr&gt;,
## #   x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;, x1993 &lt;chr&gt;, x1992 &lt;chr&gt;,
## #   x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;, x1988 &lt;chr&gt;, x1987 &lt;chr&gt;,
## #   x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<p>But not when we look at the WHEN dats:</p>
<pre class="r"><code>ttc_ridership %&gt;%
  filter(section == &quot;WHEN&quot;)</code></pre>
<pre><code>## # A tibble: 2 x 36
##   section fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012 x2011 x2010
##   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 WHEN    WEEKDAY    4172‚Ä¶ 4241‚Ä¶ 4241‚Ä¶ 4238‚Ä¶ 4232‚Ä¶ 4162‚Ä¶ 4069‚Ä¶ 3955‚Ä¶ 3798‚Ä¶
## 2 WHEN    WEEKEND/H‚Ä¶ 1041‚Ä¶ 1090‚Ä¶ 1139‚Ä¶ 1101‚Ä¶ 1115‚Ä¶ 1088‚Ä¶ 1070‚Ä¶ 1046‚Ä¶ 97547
## # ‚Ä¶ with 25 more variables: x2009 &lt;chr&gt;, x2008 &lt;chr&gt;, x2007 &lt;chr&gt;,
## #   x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;, x2003 &lt;chr&gt;, x2002 &lt;chr&gt;,
## #   x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;, x1998 &lt;chr&gt;, x1997 &lt;chr&gt;,
## #   x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;, x1993 &lt;chr&gt;, x1992 &lt;chr&gt;,
## #   x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;, x1988 &lt;chr&gt;, x1987 &lt;chr&gt;,
## #   x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<p>And it does <em>kind of</em> work when we look at the WHERE data, except there are actually <em>two</em> rows for BUS, one where it works, one where it doesn‚Äôt:</p>
<pre class="r"><code>ttc_ridership %&gt;%
  filter(section == &quot;WHERE&quot;,
         fare_media %in% c(&quot;BUS&quot;, &quot;RAIL&quot;))</code></pre>
<pre><code>## # A tibble: 3 x 36
##   section fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012 x2011 x2010
##   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 WHERE   BUS        &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 2 WHERE   BUS        2645‚Ä¶ 2611‚Ä¶ 2528‚Ä¶ 2389‚Ä¶ 2452‚Ä¶ 2399‚Ä¶ 2345‚Ä¶ 2232‚Ä¶ 2198‚Ä¶
## 3 WHERE   RAIL       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## # ‚Ä¶ with 25 more variables: x2009 &lt;chr&gt;, x2008 &lt;chr&gt;, x2007 &lt;chr&gt;,
## #   x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;, x2003 &lt;chr&gt;, x2002 &lt;chr&gt;,
## #   x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;, x1998 &lt;chr&gt;, x1997 &lt;chr&gt;,
## #   x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;, x1993 &lt;chr&gt;, x1992 &lt;chr&gt;,
## #   x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;, x1988 &lt;chr&gt;, x1987 &lt;chr&gt;,
## #   x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<p>so, in order to define the subsections, i‚Äôll handle the all of the WHO section, as well as the RAIL subsection of WHERE. I‚Äôll deal with the WHEN section and BUS subsection separately.</p>
<p>I‚Äôll need to tell <code>untangle2()</code> which rows in <code>fare_media</code> are subheads with a regular expression (i.e., regex, which I usually try to avoid). The subheaders are ‚ÄúADULT‚Äù, ‚ÄúSENIOR/STUDENT‚Äù, ‚ÄúCHILDREN‚Äù, and ‚ÄúRAIL‚Äù, so the regex should match true when it‚Äôs any of them.</p>
<p>I‚Äôm not a regex pro, so this took me a while! I know, at the very least, that <code>|</code> in a regex means ‚Äúor‚Äù, and that I‚Äôll need to escape the <code>/</code> in ‚ÄúSENIOR/STUDENT‚Äù using <code>\\</code> (i.e., <code>//\</code>):</p>
<pre class="r"><code>library(stringr)

example_subheaders &lt;- c(&quot;ADULT&quot;, &quot;SENIOR/STUDENT&quot;, &quot;CHILDREN&quot;, &quot;RAIL&quot;)
regex_attempt &lt;- &quot;ADULT|SENIOR\\/STUDENT|CHILDREN|RAIL&quot;

str_detect(example_subheaders, regex_attempt)</code></pre>
<pre><code>## [1] TRUE TRUE TRUE TRUE</code></pre>
<p>This is good! All of the strings provided match the regex.</p>
<p>But so does this string (one of the fares in the data set):</p>
<pre class="r"><code>str_detect(&quot;PRESTO - ADULT TWO-HOUR FREE RIDE&quot;, regex_attempt)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>because, after all, it <em>does</em> contain ‚ÄúADULT‚Äù! I want the subheaders to be <em>exactly</em> what I specify, not just contain the words.</p>
<p>I need to use <a href="">anchors</a>, which indicate the start (<code>^</code>) and end (<code>$</code>) of a string. A regex of ‚Äú^ADULT$‚Äù means the string starts, it contains ‚ÄúADULT‚Äù, and then it ends.</p>
<p>So this matches:</p>
<pre class="r"><code>str_detect(&quot;ADULT&quot;, &quot;^ADULT$&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>but this doesn‚Äôt:</p>
<pre class="r"><code>str_detect(&quot;PRESTO - ADULT TWO-HOUR FREE RIDE&quot;, &quot;^ADULT$&quot;)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>which is exactly what we want üéâ</p>
<p>Then, the final regex to identify the subheaders is</p>
<pre class="r"><code>subheaders_regex &lt;- &quot;^ADULT$|^SENIOR\\/STUDENT$|^CHILDREN$|^RAIL$&quot;</code></pre>
<p>And I‚Äôm ready to use <code>untangle2()</code>! It‚Äôs pretty easy to use - you provide the regex, the variable that contains the subheaders (<code>orig</code>), and the new column that will contain the values that were in the subheader (<code>new</code>):</p>
<pre class="r"><code>library(unheadr)

ttc_ridership &lt;- ttc_ridership %&gt;%
  untangle2(regex = subheaders_regex,
            orig = fare_media,
            new = subsection) %&gt;%
  select(section, subsection, everything())

head(ttc_ridership)</code></pre>
<pre><code>## # A tibble: 6 x 37
##   section subsection fare_media x2018 x2017 x2016 x2015 x2014 x2013 x2012
##   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 WHO     ADULT      TOKENS     46974 76106 1020‚Ä¶ 1109‚Ä¶ 1111‚Ä¶ 1123‚Ä¶ 1179‚Ä¶
## 2 WHO     ADULT      TICKETS    &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 3 WHO     ADULT      TWO-FARE   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 4 WHO     ADULT      PRESTO - ‚Ä¶ 1168‚Ä¶ 67829 27397 13323 9862  8194  4399 
## 5 WHO     ADULT      PRESTO - ‚Ä¶ 1752  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 6 WHO     ADULT      PRESTO - ‚Ä¶ 74    &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## # ‚Ä¶ with 27 more variables: x2011 &lt;chr&gt;, x2010 &lt;chr&gt;, x2009 &lt;chr&gt;,
## #   x2008 &lt;chr&gt;, x2007 &lt;chr&gt;, x2006 &lt;chr&gt;, x2005 &lt;chr&gt;, x2004 &lt;chr&gt;,
## #   x2003 &lt;chr&gt;, x2002 &lt;chr&gt;, x2001 &lt;chr&gt;, x2000 &lt;chr&gt;, x1999 &lt;chr&gt;,
## #   x1998 &lt;chr&gt;, x1997 &lt;chr&gt;, x1996 &lt;chr&gt;, x1995 &lt;chr&gt;, x1994 &lt;chr&gt;,
## #   x1993 &lt;chr&gt;, x1992 &lt;chr&gt;, x1991 &lt;chr&gt;, x1990 &lt;chr&gt;, x1989 &lt;chr&gt;,
## #   x1988 &lt;chr&gt;, x1987 &lt;chr&gt;, x1986 &lt;chr&gt;, x1985 &lt;chr&gt;</code></pre>
<pre class="r"><code>ttc_ridership %&gt;%
  count(section, subsection)</code></pre>
<pre><code>## # A tibble: 6 x 3
##   section subsection         n
##   &lt;chr&gt;   &lt;chr&gt;          &lt;int&gt;
## 1 WHEN    RAIL               2
## 2 WHERE   CHILDREN           2
## 3 WHERE   RAIL               4
## 4 WHO     ADULT             15
## 5 WHO     CHILDREN           9
## 6 WHO     SENIOR/STUDENT    11</code></pre>
<p>As I expected, things look right for all of the WHO sections and the WHERE/RAIL subsection, but a little off otherwise ‚Äì WHERE/CHILDREN and WHEN/RAIL don‚Äôt make much sense.</p>
<p>Let‚Äôs look at the</p>
